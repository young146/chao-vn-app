<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>ì”¬ì§œì˜¤ ë‚˜ëˆ” | ì¤‘ê³ ê±°ë˜ ë“±ë¡</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Noto Sans KR', system-ui, sans-serif;
            background: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #FF6B35, #FF8E53);
            color: #fff;
            padding: 20px 16px 24px;
            text-align: center;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
        }

        .header p {
            font-size: 13px;
            opacity: 0.9;
            margin-top: 4px;
        }

        .form-body {
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
        }

        .section {
            background: #fff;
            border-radius: 16px;
            padding: 18px 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 8px rgba(0, 0, 0, 0.06);
        }

        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: #333;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .required {
            color: #FF6B35;
            margin-left: 2px;
        }

        label {
            font-size: 13px;
            color: #666;
            display: block;
            margin-bottom: 6px;
            margin-top: 12px;
        }

        label:first-of-type {
            margin-top: 0;
        }

        input[type=text],
        input[type=number],
        input[type=tel],
        textarea,
        select {
            width: 100%;
            border: 1.5px solid #e8e8e8;
            border-radius: 10px;
            padding: 12px 14px;
            font-size: 15px;
            font-family: inherit;
            color: #222;
            background: #fafafa;
            outline: none;
            transition: border-color 0.2s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: #FF6B35;
            background: #fff;
        }

        textarea {
            resize: none;
            height: 120px;
            line-height: 1.6;
        }

        .price-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .price-row input {
            flex: 1;
        }

        .price-unit {
            font-size: 14px;
            color: #888;
            white-space: nowrap;
            font-weight: 500;
        }

        /* ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .cat-btn {
            border: 1.5px solid #e8e8e8;
            border-radius: 10px;
            padding: 10px 4px;
            background: #fff;
            font-size: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s;
            color: #555;
        }

        .cat-btn.active {
            border-color: #FF6B35;
            background: #FFF3EE;
            color: #FF6B35;
            font-weight: 700;
        }

        .cat-btn .cat-icon {
            font-size: 20px;
            display: block;
            margin-bottom: 4px;
        }

        /* ì´ë¯¸ì§€ ì—…ë¡œë“œ */
        .image-upload-area {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .img-add-btn {
            width: 90px;
            height: 90px;
            border: 2px dashed #ddd;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #aaa;
            font-size: 12px;
            gap: 4px;
            background: #fafafa;
        }

        .img-add-btn .plus {
            font-size: 28px;
            line-height: 1;
        }

        .img-preview-wrap {
            position: relative;
            width: 90px;
            height: 90px;
            border-radius: 12px;
            overflow: hidden;
        }

        .img-preview-wrap img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .img-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(0, 0, 0, 0.55);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .img-count {
            font-size: 12px;
            color: #888;
            margin-top: 6px;
        }

        /* ì œì¶œ ë²„íŠ¼ */
        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #FF6B35, #FF8E53);
            color: #fff;
            border: none;
            border-radius: 14px;
            padding: 16px;
            font-size: 16px;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            margin-top: 8px;
            margin-bottom: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: opacity 0.2s;
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ì™„ë£Œ í™”ë©´ */
        #success-screen {
            display: none;
            padding: 32px 16px;
            max-width: 600px;
            margin: 0 auto;
        }

        .success-card {
            background: #fff;
            border-radius: 20px;
            padding: 28px 20px;
            text-align: center;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
        }

        .success-icon {
            font-size: 52px;
            margin-bottom: 12px;
        }

        .success-title {
            font-size: 20px;
            font-weight: 700;
            color: #222;
        }

        .success-sub {
            font-size: 14px;
            color: #888;
            margin-top: 8px;
            line-height: 1.6;
        }

        .kakao-share-box {
            background: #FEE500;
            border-radius: 14px;
            padding: 16px;
            margin-top: 20px;
            text-align: left;
        }

        .kakao-share-label {
            font-size: 13px;
            font-weight: 700;
            color: #3C1E1E;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .kakao-share-text {
            font-size: 13px;
            color: #3C1E1E;
            white-space: pre-wrap;
            line-height: 1.7;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            padding: 12px;
        }

        .copy-btn {
            width: 100%;
            background: #3C1E1E;
            color: #FEE500;
            border: none;
            border-radius: 10px;
            padding: 12px;
            font-size: 14px;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            margin-top: 10px;
        }

        .share-kakao-btn {
            width: 100%;
            background: #FEE500;
            color: #3C1E1E;
            border: none;
            border-radius: 14px;
            padding: 18px;
            font-size: 18px;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            margin-top: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(254, 229, 0, 0.4);
        }

        .another-btn {
            width: 100%;
            background: #FF6B35;
            color: #fff;
            border: none;
            border-radius: 14px;
            padding: 14px;
            font-size: 15px;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            margin-top: 12px;
        }

        /* ë¡œë”© */
        .loading-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.85);
            z-index: 100;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 44px;
            height: 44px;
            border: 4px solid #FFE0D0;
            border-top-color: #FF6B35;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .back-link {
            display: block;
            text-align: center;
            color: #FF6B35;
            font-size: 14px;
            margin-bottom: 16px;
            text-decoration: none;
            padding: 8px;
        }
    </style>
</head>

<body>

    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <div class="loading-text" id="loading-text">ì—…ë¡œë“œ ì¤‘...</div>
    </div>

    <div id="form-screen">
        <div class="header">
            <h1>ğŸ›ï¸ ì”¬ì§œì˜¤ ë‚˜ëˆ”</h1>
            <p>ì¤‘ê³ ê±°ë˜ Â· ë¬´ë£Œë‚˜ëˆ” ë“±ë¡</p>
        </div>

        <div class="form-body">
            <a href="../" class="back-link">â† ì¹´í…Œê³ ë¦¬ ì„ íƒìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>

            <!-- ì¹´í…Œê³ ë¦¬ -->
            <div class="section">
                <div class="section-title">ğŸ“¦ ì¹´í…Œê³ ë¦¬ <span class="required">*</span></div>
                <div class="category-grid" id="cat-grid">
                    <button class="cat-btn active" data-val="ë¬´ë£Œë‚˜ëˆ”" onclick="selectCat(this)">
                        <span class="cat-icon">ğŸ</span>ë¬´ë£Œë‚˜ëˆ”
                    </button>
                    <button class="cat-btn" data-val="ì „ìì œí’ˆ" onclick="selectCat(this)">
                        <span class="cat-icon">ğŸ“±</span>ì „ìì œí’ˆ
                    </button>
                    <button class="cat-btn" data-val="ê°€êµ¬/ì¸í…Œë¦¬ì–´" onclick="selectCat(this)">
                        <span class="cat-icon">ğŸª‘</span>ê°€êµ¬/ì¸í…Œë¦¬ì–´
                    </button>
                    <button class="cat-btn" data-val="ì˜ë¥˜/ì¡í™”" onclick="selectCat(this)">
                        <span class="cat-icon">ğŸ‘—</span>ì˜ë¥˜/ì¡í™”
                    </button>
                    <button class="cat-btn" data-val="ìƒí™œìš©í’ˆ" onclick="selectCat(this)">
                        <span class="cat-icon">ğŸ </span>ìƒí™œìš©í’ˆ
                    </button>
                    <button class="cat-btn" data-val="ë„ì„œ/ë¬¸êµ¬" onclick="selectCat(this)">
                        <span class="cat-icon">ğŸ“š</span>ë„ì„œ/ë¬¸êµ¬
                    </button>
                    <button class="cat-btn" data-val="ìœ ì•„ìš©í’ˆ" onclick="selectCat(this)">
                        <span class="cat-icon">ğŸ‘¶</span>ìœ ì•„ìš©í’ˆ
                    </button>
                    <button class="cat-btn" data-val="í« ìš©í’ˆ" onclick="selectCat(this)">
                        <span class="cat-icon">ğŸ¾</span>í« ìš©í’ˆ
                    </button>
                    <button class="cat-btn" data-val="ê¸°íƒ€" onclick="selectCat(this)">
                        <span class="cat-icon">ğŸ“¦</span>ê¸°íƒ€
                    </button>
                </div>
            </div>

            <!-- ì‚¬ì§„ -->
            <div class="section">
                <div class="section-title">ğŸ“· ì‚¬ì§„ (ìµœëŒ€ 5ì¥)</div>
                <div class="image-upload-area" id="img-area">
                    <div class="img-add-btn" onclick="document.getElementById('file-input').click()">
                        <span class="plus">+</span>
                        <span>ì‚¬ì§„ ì¶”ê°€</span>
                    </div>
                </div>
                <div class="img-count" id="img-count">0 / 5</div>
                <input type="file" id="file-input" accept="image/*" multiple style="display:none"
                    onchange="handleImages(this)">
            </div>

            <!-- ê¸°ë³¸ ì •ë³´ -->
            <div class="section">
                <div class="section-title">âœï¸ ê¸°ë³¸ ì •ë³´</div>

                <label>ì œëª© <span class="required">*</span></label>
                <input type="text" id="title" placeholder="ì˜ˆ: ê°¤ëŸ­ì‹œ S23 íŒë‹ˆë‹¤" maxlength="50">

                <label>ê°€ê²© (VND)</label>
                <div class="price-row">
                    <input type="number" id="price" placeholder="0 = ê°€ê²© í˜‘ì˜ ë˜ëŠ” ë¬´ë£Œë‚˜ëˆ”" min="0">
                    <span class="price-unit">â‚« VND</span>
                </div>

                <label>ìƒì„¸ ì„¤ëª… <span class="required">*</span></label>
                <textarea id="description" placeholder="ë¬¼í’ˆ ìƒíƒœ, êµ¬ë§¤ ì‹œê¸°, íŒë§¤ ì´ìœ  ë“±ì„ ìì„¸íˆ ì ì–´ì£¼ì„¸ìš”"></textarea>
            </div>

            <!-- ìœ„ì¹˜ -->
            <div class="section">
                <div class="section-title">ğŸ“ ìœ„ì¹˜</div>
                <label>ë„ì‹œ <span class="required">*</span></label>
                <select id="city" onchange="updateDistrict()">
                    <option value="">ë„ì‹œ ì„ íƒ</option>
                    <option value="í˜¸ì¹˜ë¯¼">í˜¸ì¹˜ë¯¼</option>
                    <option value="í•˜ë…¸ì´">í•˜ë…¸ì´</option>
                    <option value="ë‹¤ë‚­">ë‹¤ë‚­</option>
                    <option value="ëƒì§±">ëƒì§±</option>
                    <option value="ë¶•ë”°ìš°">ë¶•ë”°ìš°</option>
                    <option value="ë¹ˆì¦">ë¹ˆì¦</option>
                    <option value="ë™ë‚˜ì´">ë™ë‚˜ì´</option>
                    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                </select>

                <label>êµ¬/êµ°</label>
                <select id="district">
                    <option value="">êµ¬/êµ° ì„ íƒ (ì„ íƒì‚¬í•­)</option>
                </select>

                <label>ì•„íŒŒíŠ¸/ì§€ì—­</label>
                <input type="text" id="apartment" placeholder="ì˜ˆ: ë¹ˆí™ˆ ì„¼íŠ¸ëŸ´íŒŒí¬, ë§ˆìŠ¤í…Œë¦¬ ë“±">
            </div>

            <!-- ì—°ë½ì²˜ -->
            <div class="section">
                <div class="section-title">ğŸ“ ì—°ë½ì²˜ <span class="required">*</span></div>
                <p style="font-size:12px;color:#888;margin-bottom:12px">ìµœì†Œ í•˜ë‚˜ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”</p>

                <label>ì „í™”ë²ˆí˜¸</label>
                <input type="tel" id="phone" placeholder="010-1234-5678 ë˜ëŠ” +84-123-456-789">

                <label>ì¹´ì¹´ì˜¤í†¡ ID</label>
                <input type="text" id="kakao-id" placeholder="kakao_id123">

                <label>ê¸°íƒ€ ì—°ë½ì²˜ (Zalo ë“±)</label>
                <input type="text" id="other-contact" placeholder="Zalo: 0123456789">

                <label>ì´ë¦„/ë‹‰ë„¤ì„</label>
                <input type="text" id="seller-name" placeholder="í™ê¸¸ë™ (ì„ íƒì‚¬í•­)">
            </div>

            <button class="submit-btn" id="submit-btn" onclick="submitForm()">
                âœ… ë“±ë¡í•˜ê¸°
            </button>
        </div>
    </div>

    <!-- ì™„ë£Œ í™”ë©´ -->
    <div id="success-screen">
        <div class="header" style="background: linear-gradient(135deg, #4CAF50, #66BB6A);">
            <h1>âœ… ë“±ë¡ ì™„ë£Œ!</h1>
            <p>ì”¬ì§œì˜¤ ì•±ì— ìë™ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤</p>
        </div>
        <div style="padding: 16px; max-width: 600px; margin: 0 auto;">
            <div class="success-card">
                <div class="success-icon">ğŸ‰</div>
                <div class="success-title">ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
                <div class="success-sub">ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°”ë¡œ ì˜¤í”ˆì±„íŒ…ì— ê³µìœ í•˜ì„¸ìš”!</div>

                <button class="share-kakao-btn" onclick="shareToKakao()">ğŸ’¬ ì¹´ì¹´ì˜¤í†¡ì— ê³µìœ í•˜ê¸°</button>

                <div class="kakao-share-box">
                    <div class="kakao-share-label">ğŸ“‹ ê³µìœ  ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°</div>
                    <div class="kakao-share-text" id="share-text"></div>
                    <button class="copy-btn" onclick="copyText()">ğŸ“‹ í…ìŠ¤íŠ¸ë§Œ ë³µì‚¬í•˜ê¸°</button>
                </div>

                <button class="another-btn" onclick="location.reload()">+ ë˜ ë‹¤ë¥¸ ë¬¼í’ˆ ë“±ë¡í•˜ê¸°</button>
                <hr style="margin: 16px 0; border-color: #f0f0f0;">
                <a href="../" style="display:block; text-align:center; color:#888; font-size:13px;">â† ì²˜ìŒìœ¼ë¡œ</a>
            </div>
        </div>
    </div>

    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.4/kakao.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js';
        import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js';

        if (typeof Kakao !== 'undefined' && !Kakao.isInitialized()) {
            Kakao.init('eb4612604473e026e6cc7ed41ededbc3');
        }

        const firebaseConfig = {
            apiKey: "AIzaSyAAtT9gcu8eVQIhQxYEgBTGp2XZ6ghz_NU",
            authDomain: "chaovietnam-login.firebaseapp.com",
            projectId: "chaovietnam-login",
            storageBucket: "chaovietnam-login.firebasestorage.app",
            messagingSenderId: "249390849714",
            appId: "1:249390849714:web:95ae3e7f066b70ffe973ab",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);

        // ì§€êµ¬/êµ° ë°ì´í„°
        const districtData = {
            'í˜¸ì¹˜ë¯¼': ['1êµ°', '2êµ°', '3êµ°', '4êµ°', '5êµ°', '6êµ°', '7êµ°(í‘¸ë¯¸í¥)', '8êµ°', '9êµ°', '10êµ°', '11êµ°', '12êµ°', 'ë¹ˆíƒ„', 'ë¹ˆì°', 'ê³ ë°¥', 'ë–¤ë¹ˆ', 'ë–¤í‘¸', 'í‘¸ëˆ„ì•ˆ', 'ë¹ˆëŒ€', 'ë¹ˆì°Œì—ìš°', 'í˜¸í¬ëª¬', 'ê¾¸ì¹˜', 'ê¹Œì´ë² ', 'ëƒë² '],
            'í•˜ë…¸ì´': ['ë°”ë”˜', 'í˜¸ì•ˆë¼ì— ', 'ë™ë‹¤', 'í•˜ì´ë°”ì¯©', 'ë™ì•„ì¸', 'ë– ì´í˜¸', 'ì¥ë¹„', 'ê¹Œìš°ì ¸ì´', 'í•˜ë™', 'ë¡±ë¹„ì—”', 'ë‚¨ëšœë¦¬ì— ', 'ë°•ëšœë¦¬ì— ', 'í˜¸ì•„ì¸'],
            'ë‹¤ë‚­': ['í•˜ì´ì©Œìš°', 'íƒ„í¬', 'ë¦¬ì—”ì°Œì—ìš°', 'ì‘ìš°í•œì„ ', 'ì†ì§œ', 'í•˜ì´ì©Œìš°', 'ê¹Œë§ˆìš°'],
            'ëƒì§±': ['ëƒì§± ì‹œë‚´'],
            'ë¶•ë”°ìš°': ['ë¶•ë”°ìš° ì‹œë‚´'],
            'ë¹ˆì¦': ['íˆ¬ë‹¤ìš°ëª»', 'íƒ„ì•ˆ', 'ë””ì•ˆ', 'í† ì•™ì•ˆ'],
            'ë™ë‚˜ì´': ['ë¹„ì—”í™”'],
            'ê¸°íƒ€': [],
        };

        window.updateDistrict = function () {
            const city = document.getElementById('city').value;
            const distSel = document.getElementById('district');
            distSel.innerHTML = '<option value="">êµ¬/êµ° ì„ íƒ (ì„ íƒì‚¬í•­)</option>';
            (districtData[city] || []).forEach(d => {
                const opt = document.createElement('option');
                opt.value = d; opt.textContent = d;
                distSel.appendChild(opt);
            });
        };

        // ì¹´í…Œê³ ë¦¬ ì„ íƒ
        let selectedCat = 'ë¬´ë£Œë‚˜ëˆ”';
        window.selectCat = function (btn) {
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedCat = btn.dataset.val;
        };

        // ì´ë¯¸ì§€ ê´€ë¦¬
        let imageFiles = [];
        window.handleImages = function (input) {
            const files = Array.from(input.files);
            const remaining = 5 - imageFiles.length;
            const toAdd = files.slice(0, remaining);
            imageFiles = [...imageFiles, ...toAdd];
            renderImages();
            input.value = '';
        };

        function renderImages() {
            const area = document.getElementById('img-area');
            area.innerHTML = '';
            imageFiles.forEach((f, i) => {
                const wrap = document.createElement('div');
                wrap.className = 'img-preview-wrap';
                const img = document.createElement('img');
                img.src = URL.createObjectURL(f);
                const btn = document.createElement('button');
                btn.className = 'img-remove';
                btn.innerHTML = 'Ã—';
                btn.onclick = () => { imageFiles.splice(i, 1); renderImages(); };
                wrap.appendChild(img); wrap.appendChild(btn);
                area.appendChild(wrap);
            });
            if (imageFiles.length < 5) {
                const addBtn = document.createElement('div');
                addBtn.className = 'img-add-btn';
                addBtn.innerHTML = '<span class="plus">+</span><span>ì‚¬ì§„ ì¶”ê°€</span>';
                addBtn.onclick = () => document.getElementById('file-input').click();
                area.appendChild(addBtn);
            }
            document.getElementById('img-count').textContent = `${imageFiles.length} / 5`;
        }

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ
        async function uploadImage(file, userId) {
            const ext = file.name.split('.').pop() || 'jpg';
            const path = `items-web/${userId}_${Date.now()}_${Math.random().toString(36).slice(2)}.${ext}`;
            const imgRef = ref(storage, path);

            // ë¦¬ì‚¬ì´ì¦ˆ
            const resized = await resizeImage(file, 800);
            await uploadBytes(imgRef, resized);
            return await getDownloadURL(imgRef);
        }

        function resizeImage(file, maxW) {
            return new Promise(resolve => {
                const img = new Image();
                const url = URL.createObjectURL(file);
                img.onload = () => {
                    const ratio = Math.min(1, maxW / img.width);
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width * ratio;
                    canvas.height = img.height * ratio;
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob(resolve, 'image/jpeg', 0.8);
                    URL.revokeObjectURL(url);
                };
                img.src = url;
            });
        }

        window.submitForm = async function () {
            const title = document.getElementById('title').value.trim();
            const price = document.getElementById('price').value;
            const description = document.getElementById('description').value.trim();
            const city = document.getElementById('city').value;
            const district = document.getElementById('district').value;
            const apartment = document.getElementById('apartment').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const kakaoId = document.getElementById('kakao-id').value.trim();
            const otherContact = document.getElementById('other-contact').value.trim();
            const sellerName = document.getElementById('seller-name').value.trim();

            if (!title) { alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            if (!description) { alert('ìƒì„¸ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            if (!city) { alert('ë„ì‹œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            if (!phone && !kakaoId && !otherContact) { alert('ì—°ë½ì²˜ë¥¼ ìµœì†Œ í•˜ë‚˜ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            const loading = document.getElementById('loading');
            loading.classList.add('active');

            try {
                // ìµëª… ë¡œê·¸ì¸
                document.getElementById('loading-text').textContent = 'ì¸ì¦ ì¤‘...';
                const userCred = await signInAnonymously(auth);
                const uid = userCred.user.uid;

                // ì´ë¯¸ì§€ ì—…ë¡œë“œ
                let imageUrls = [];
                for (let i = 0; i < imageFiles.length; i++) {
                    document.getElementById('loading-text').textContent = `ì‚¬ì§„ ì—…ë¡œë“œ ì¤‘ (${i + 1}/${imageFiles.length})...`;
                    const url = await uploadImage(imageFiles[i], uid);
                    imageUrls.push(url);
                }

                // Firestore ì €ì¥
                document.getElementById('loading-text').textContent = 'ë“±ë¡ ì¤‘...';
                const docData = {
                    title,
                    price: price ? parseInt(price) : 0,
                    description,
                    category: selectedCat,
                    city: city || '',
                    district: district || '',
                    apartment: apartment || '',
                    location: `${city} ${district} ${apartment}`.trim(),
                    images: imageUrls,
                    contact: {
                        phone: phone || '',
                        kakaoId: kakaoId || '',
                        other: otherContact || '',
                    },
                    userId: uid,
                    userEmail: 'kakaotalk-web@chaovietnam.co.kr',
                    userName: sellerName || 'ì¹´ì¹´ì˜¤ ë“±ë¡',
                    source: 'kakaotalk-web',
                    status: 'íŒë§¤ì¤‘',
                    createdAt: serverTimestamp(),
                };
                const docRef = await addDoc(collection(db, 'XinChaoDanggn'), docData);

                // ê³µìœ  í…ìŠ¤íŠ¸ ìƒì„±
                const priceText = price && parseInt(price) > 0
                    ? `${parseInt(price).toLocaleString()}â‚« VND`
                    : 'ê°€ê²© í˜‘ì˜ / ë¬´ë£Œë‚˜ëˆ”';
                const contactText = [phone, kakaoId ? `ì¹´ì¹´ì˜¤: ${kakaoId}` : '', otherContact].filter(Boolean).join(' | ');
                const shareText = [
                    `ğŸ“¦ [${selectedCat}] ${title}`,
                    `ğŸ’° ê°€ê²©: ${priceText}`,
                    city ? `ğŸ“ ìœ„ì¹˜: ${city}${district ? ' ' + district : ''}${apartment ? ' ' + apartment : ''}` : '',
                    ``,
                    description.length > 200 ? description.slice(0, 200) + '...' : description,
                    ``,
                    `ğŸ“ ì—°ë½ì²˜: ${contactText}`,
                    ``,
                    `ğŸ”— ì”¬ì§œì˜¤ ì•± ë‹¤ìš´ë¡œë“œ â†’ https://play.google.com/store/apps/details?id=com.yourname.chaovnapp`,
                ].filter(l => l !== null).join('\n');

                document.getElementById('share-text').textContent = shareText;

                window.shareContent = {
                    id: docRef.id,
                    title: `ğŸ“¦ [${selectedCat}] ${title}`,
                    description: `ğŸ’° ${priceText}\nğŸ“ ${city}${district ? ' ' + district : ''}\nğŸ“ ${description.length > 50 ? description.slice(0, 50) + '...' : description}`,
                    imageUrl: imageUrls.length > 0 ? imageUrls[0] : 'https://chaovietnam-login.web.app/assets/icon.png'
                };
                document.getElementById('form-screen').style.display = 'none';
                document.getElementById('success-screen').style.display = 'block';
                window.scrollTo(0, 0);
            } catch (e) {
                console.error(e);
                alert('ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
                submitBtn.disabled = false;
            } finally {
                loading.classList.remove('active');
            }
        };

        window.shareToKakao = function () {
            const content = window.shareContent;
            if (!content) return;

            if (typeof Kakao === 'undefined') {
                const text = document.getElementById('share-text').textContent;
                navigator.clipboard.writeText(text);
                alert('ì¹´ì¹´ì˜¤í†¡ ì‹œìŠ¤í…œ ì¼ì‹œ ì˜¤ë¥˜ì…ë‹ˆë‹¤. í…ìŠ¤íŠ¸ê°€ ëŒ€ì‹  ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nì¹´ì¹´ì˜¤í†¡ì— ê¸¸ê²Œ ëˆŒëŸ¬ ë¶™ì—¬ë„£ê¸° í•´ì£¼ì„¸ìš”!');
                return;
            }

            Kakao.Share.sendDefault({
                objectType: 'feed',
                content: {
                    title: content.title,
                    description: content.description,
                    imageUrl: content.imageUrl,
                    link: {
                        mobileWebUrl: `https://chaovietnam-login.web.app/download.html?type=danggn&id=${content.id}`,
                        webUrl: `https://chaovietnam-login.web.app/download.html?type=danggn&id=${content.id}`,
                    },
                },
                buttons: [
                    {
                        title: 'ì•±ì—ì„œ ìì„¸íˆ ë³´ê¸°',
                        link: {
                            mobileWebUrl: `https://chaovietnam-login.web.app/download.html?type=danggn&id=${content.id}`,
                            webUrl: `https://chaovietnam-login.web.app/download.html?type=danggn&id=${content.id}`,
                        },
                    },
                ],
            });
        };

        window.copyText = function () {
            const text = document.getElementById('share-text').textContent;
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector('.copy-btn');
                btn.textContent = 'âœ… ë³µì‚¬ë¨!';
                setTimeout(() => { btn.textContent = 'ğŸ“‹ í…ìŠ¤íŠ¸ë§Œ ë³µì‚¬í•˜ê¸°'; }, 2000);
            });
        };
    </script>
</body>

</html>