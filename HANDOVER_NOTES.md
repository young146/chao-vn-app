# 프로젝트 인계 및 현재 상태 명세서 (Handover Notes)

본 문서는 앱의 주요 기능 개선 사항과 현재 해결 중인 구글 로그인 이슈의 상세 과정을 기록한 문서입니다. 다음 작업자가 현재의 맥락을 즉시 파악하고 이어서 작업할 수 있도록 작성되었습니다.

## 1. 최근 완료된 주요 개선 사항 (성공 사례)

### 1.1 초기 로딩 속도 최적화 (0초 로딩 구현)
- **배경:** 당근 메뉴 진입 시 데이터 로딩에 15초 이상 소요되어 사용자 이탈 위험이 컸음.
- **조치:** 
    - `App.js`에서 앱 실행 즉시 배경에서 당근 데이터와 상위 6개 이미지를 프리페치(Prefetch)하여 `AsyncStorage` 및 이미지 캐시에 저장.
    - `XinChaoDanggnScreen.js`에서 서버 데이터를 기다리지 않고 캐시 데이터를 즉시 표시하도록 수정.
- **결과:** 메뉴 진입 시 체감 로딩 속도 0초 달성.

### 1.2 채팅 성능 및 리스트 최적화
- **채팅방 목록:** 프리페치 로직을 적용하고, 중복 키 에러를 방지하기 위해 `Map` 객체를 이용한 유니크 필터링 적용.
- **메시지 로딩:** `limitToLast(50)`을 적용하여 최신 메시지 위주로 로딩 속도 개선.
- **중복 에러 해결:** `FlatList`에서 발생하던 `Encountered two children with the same key` 에러를 모든 주요 리스트(당근, 채팅목록)에서 로직적으로 차단함.

### 1.3 데이터 필터링 및 인덱스 에러 대응
- **클라이언트 사이드 정렬:** Firestore의 복합 인덱스 생성 부담을 줄이기 위해 서버 측 `orderBy`를 제거하고, 클라이언트에서 데이터를 받아온 후 정렬하는 방식으로 변경하여 인덱스 에러 발생 차단.
- **카테고리 불일치 수정:** 아이템 등록(`AddItemScreen`)과 목록 조회(`XinChaoDanggnScreen`) 간의 카테고리 텍스트 불일치 문제 해결.

## 2. 현재 진행 중인 핵심 이슈: 구글 로그인 실패

### 2.1 증상 및 에러 메시지
- **에러 내용:** `Error 400: invalid_request`, `Custom scheme URIs are not allowed for 'WEB' client type`.
- **상황:** 구글 로그인 버튼 클릭 시 계정 선택 창으로 넘어가지 못하고 입구에서 차단됨. (이전에는 계정 선택까지는 되었으나 돌아오는 길에 `Something went wrong` 발생)

### 2.2 시도된 조치 및 분석
- **clientId 설정:** 웹 클라이언트 ID를 사용하여 `useProxy: true` 환경에서 HTTPS 리디렉션을 시도함.
- **원인 추정:** 현재 앱이 **'개발 빌드(Development Build)'** 환경에서 실행 중이며, `AuthSession`이 생성하는 `redirect_uri`가 구글 웹 클라이언트가 허용하지 않는 커스텀 스키마(`exp+...` 또는 `com.yourname...`)로 생성되고 있음.
- **실패한 시도들:**
    - `makeRedirectUri`를 이용해 수동으로 주소를 고정하려 했으나 실패.
    - `app.json`에 `owner` 정보를 추가하여 Expo 프록시 서버와의 정체성 일치를 시도했으나 효과 없음.
    - `responseType`을 `token`과 `id_token`으로 번갈아 시도함.

### 2.3 차기 작업자를 위한 권장 사항
1. **Redirect URI 강제 확인:** `promptAsync` 실행 직전 `request.redirectUri` 값이 정확히 `https://auth.expo.io/@young146/chao-vn-app`으로 나오는지 로그 확인 필수.
2. **구글 콘솔 재설정:** 웹 클라이언트 ID의 '승인된 리디렉션 URI'에 위 주소가 정확히 등록되어 있는지 확인.
3. **네이티브 모듈 검토:** 개발 빌드에서는 `expo-auth-session`이 아닌 `react-native-google-signin` 같은 순수 네이티브 라이브러리 도입을 고려해야 할 수도 있음 (현재 Expo 프록시 방식이 개발 빌드와 충돌 가능성 높음).

## 3. 2025년 1월 4일 작업 내역 및 ⚠️ 심각한 문제 발생

### 3.1 성공적으로 완료된 최적화

#### 앱 로딩 속도 획기적 개선
- **이전:** 앱 로딩에 약 10초 이상 소요
- **조치:** 
  - `services/wordpressApi.js`에 `getHomeDataCached()` 함수 추가
  - 10개의 순차 API 호출을 1개의 병렬 호출로 통합
  - AsyncStorage 캐시 + Stale-While-Revalidate 전략 적용
  - `App.js`에서 캐시 우선 로딩 구현
- **결과:** 
  - 첫 실행: ~3.5초
  - 재실행(캐시): 0.013초 (즉시 진입)

#### 구글 로그인 속도 개선
- **이전:** 계정 선택 후 로그인까지 약 15초 소요
- **조치:**
  - `AuthContext.js`에서 푸시 토큰 등록을 백그라운드로 이동 (await 제거)
  - Firestore setDoc 작업들을 Promise.all로 병렬화
- **결과:** 로그인 시간 약 2-3초로 단축

#### 구글 로그인 계정 선택 기능 복원
- `LoginScreen.js`에서 `GoogleSignin.signOut()` 재활성화
- 매번 다른 계정 선택 가능하도록 수정

### 3.2 ⚠️ 심각한 문제: 채팅 알림 완전 불능

#### 문제 상황
- **증상:** 채팅 알림이 전혀 작동하지 않음
  - 앱이 열려있을 때: 알림 안 옴
  - 앱이 닫혀있을 때: 알림 안 옴 (소리도, 메시지도 없음)
- **원인:** 불명확 - 롤백 후에도 문제 지속

#### 시도한 조치들 (모두 실패)

1. **채팅 전송 속도 개선 시도 (ChatRoomScreen.js)**
   - 낙관적 업데이트(Optimistic Update) 구현 시도
   - 결과: 메시지창 깜빡임, 알람 완전 중단
   - **롤백 완료:** commit 5dc6056으로 복원

2. **Firebase Functions 수정 (functions/index.js)**
   - FCM 페이로드에서 channelId, icon 등 수정 시도
   - 결과: 효과 없음
   - **롤백 완료:** commit 5dc6056으로 복원

3. **AuthContext.js 수정**
   - 푸시 토큰 등록 백그라운드 처리
   - 결과: 로그인은 빨라졌으나 알림 문제와 연관 가능성
   - **롤백 완료:** commit 5dc6056으로 복원

4. **App.js 알림 채널 명시적 생성**
   - `setupNotificationChannels()` 함수 추가하여 앱 시작 시 chat 채널 생성
   - 결과: 효과 없음

#### 현재 상태 (2025년 1월 4일)

| 파일 | 상태 | 비고 |
|------|------|------|
| `AuthContext.js` | ✅ 출시 버전 동일 | git diff 확인 완료 |
| `ChatRoomScreen.js` | ✅ 출시 버전 동일 | git diff 확인 완료 |
| `functions/index.js` | ✅ 출시 버전 동일 | git diff 확인 완료 |
| `App.js` | ⚠️ 수정됨 | 로딩 최적화 + 알림 채널 코드 추가 |
| `wordpressApi.js` | ⚠️ 수정됨 | 캐싱 최적화 코드 추가 |
| `LoginScreen.js` | ⚠️ 수정됨 | 구글 로그인 signOut() 복원 |

#### 로그 상태 (정상으로 보임)
```
✅ 알림 채널 생성 완료!
📲 Expo Push Token: ExponentPushToken[UnukgbJB3-aGQUOMqGGCjc]
🔥 FCM/APNS Device Token: eX6i5bpIQTKoafzVjFsvVO:APA91bH...
✅ 푸시 토큰 저장 완료
```

#### 🚨 교훈: "빈대 하나 잡으려다 집을 태웠다"
- 채팅 메시지 전송 속도 개선을 시도하다가 알림 시스템 전체가 망가짐
- 원인 파악 불가 - 롤백해도 복구 안됨
- 출시된 앱에서는 정상 작동하므로 개발 빌드 환경 문제일 가능성 있음

### 3.3 차기 작업자를 위한 권장 사항

1. **절대 함부로 수정하지 말 것** - 알림 관련 코드는 민감함
2. **출시 앱과 개발 앱 비교 테스트** - 같은 코드인데 다르게 동작할 수 있음
3. **Firebase Functions 로그 확인** - Console에서 실제 전송 성공/실패 확인 필요
4. **수신자 기기의 토큰 갱신** - 개발 빌드에서 토큰이 달라질 수 있음
5. **완전 롤백 고려** - App.js, wordpressApi.js도 출시 버전으로 복원 후 테스트

### 3.4 추가 확인 사항 (2025년 1월 4일 오후)

#### ✅ 알람 복구 확인
- 개발 앱과 출시 앱 동시 테스트 결과, **알람이 다시 정상 작동**함
- 원인 불명 - 시간이 지나면서 자연 복구된 것으로 추정

#### ⚠️ 남은 문제들

1. **메시지 전송 속도 느림**
   - 전송 버튼 누른 후 실제 전송까지 체감 지연 있음

2. **키보드 올라왔을 때 화면 흔들림 (심각)**
   - 증상: 키보드가 올라온 상태에서 화면이 파도치듯 흔들림
   - 원인: Firestore WebChannel 연결 에러
   ```
   @firebase/firestore: Firestore (12.6.0): WebChannelConnection RPC 'Listen' stream transport errored
   ```
   - 연결이 끊겼다가 재연결되면서 리스너가 50개 메시지를 다시 받아옴
   - 이 과정에서 FlatList가 반복 렌더링되어 화면 흔들림 발생

3. **Firestore 연결 불안정**
   - 개발 빌드 환경에서 Firestore 연결이 자주 끊김
   - `transport errored` 메시지 반복 발생

#### 잠재적 해결 방안 (미적용)
- ChatRoomScreen.js에서 메시지 수신 시 중복 방지 로직 강화
- FlatList에 `extraData` 의존성 최적화
- Firestore 연결 상태 모니터링 및 재연결 핸들링
- **주의:** 함부로 수정 시 알람이 다시 망가질 수 있으므로 신중히 접근 필요

## 4. 남은 작업 (Pending Tasks)
- [x] ~~**앱 로딩 속도 최적화**~~ - 완료 (0초 로딩 구현)
- [x] ~~**구글 로그인 속도 개선**~~ - 완료 (15초 → 2-3초)
- [x] ~~**채팅 알림 복구**~~ - 완료 (자연 복구됨)
- [ ] **채팅 전송 속도 개선** - 미해결
- [ ] **키보드 시 화면 흔들림 수정** - 미해결 (Firestore 연결 문제)
- [ ] **안정성 테스트:** 성능 개선 사항이 실제 사용자 기기에서 작동하는지 모니터링

---
**최종 업데이트 일자:** 2025년 1월 4일
**작업 상태:** ⚠️ 위험 - 로딩 최적화는 성공했으나 채팅 알림이 완전히 망가진 상태. 원인 불명.
